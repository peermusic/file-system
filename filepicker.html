<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset=utf-8 />
    <title>A File Display Demo</title>
    <script type="text/javascript">

        /*
         * To run this test page you have to start Chrome with an startup option: --allow-file-access-from-files
         * For example:
         *  (windows):  Run "CMD" and enter "PATH-to-Chrome" + " --allow-file-access-from-files"
         *              - "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" --allow-file-access-from-files
         *
         *
         */

        <!--Filepicker-->

        //Function: ErrorHandler
        function errorHandler(e) {
            var msg = '';

            switch (e.code) {
                case FileError.QUOTA_EXCEEDED_ERR:
                    msg = 'QUOTA_EXCEEDED_ERR';
                    break;
                case FileError.NOT_FOUND_ERR:
                    msg = 'NOT_FOUND_ERR';
                    break;
                case FileError.SECURITY_ERR:
                    msg = 'SECURITY_ERR';
                    break;
                case FileError.INVALID_MODIFICATION_ERR:
                    msg = 'INVALID_MODIFICATION_ERR';
                    break;
                case FileError.INVALID_STATE_ERR:
                    msg = 'INVALID_STATE_ERR';
                    break;
                default:
                    msg = 'Unknown Error';
                    break;
            };
            console.log('Error: ' + msg);
        }

        function toArray(list) {
            return Array.prototype.slice.call(list || [], 0);
        }

        //Function: Add Files to FS
        //@para files - array: file object
        function addFilesIntoFS(files){
            window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
            window.requestFileSystem(window.TEMPORARY, 64*1024*1024, function(fs) {
                // Duplicate each file the user selected to the app's fs.
                for (var i = 0, file; file = files[i]; ++i) {
                    // Capture current iteration's file in local scope for the getFile() callback.
                    (function(f) {
                        fs.root.getFile(f.name, {create: true, exclusive: true}, function(fileEntry) {
                            fileEntry.createWriter(function(fileWriter) {
                                fileWriter.write(f); // Note: write() can take a File or Blob object.
                            }, errorHandler);
                        }, errorHandler);
                    })(file);
                }
            }, errorHandler);
        }

        //Function: add files to list
        //@param: entries Array: FileEntry
        function listResults(entries) {
            var fragment = document.createDocumentFragment();

            entries.forEach(function(entry, i) {
                var img = entry.isDirectory ? '<img src="folder-icon.gif">' ://TODO: edited path
                        '<img src="file-icon.gif">';
                var li = document.createElement('li');
                li.innerHTML = [img, '<span>', entry.name, '</span>'].join('');
                fragment.appendChild(li);
            });
            document.querySelector('#list').appendChild(fragment);
        }

        //Function: Get the FSEntries
        function showFS(){
            window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
            window.requestFileSystem(window.TEMPORARY, 64*1024*1024, function(fs) {
                //clear list
                var list = document.querySelector('#list');
                while (list.firstChild) {
                    list.removeChild(list.firstChild);
                }
                var entries = getAllEntries(fs, function(entries) {
                    listResults(entries);
                });
            }, errorHandler);
        }

        function getAllEntries(fs, callback){
            var dirReader = fs.root.createReader();
            var entries = [];

            // Call the reader.readEntries() until no more results are returned.
            var readEntries = function() {
                dirReader.readEntries (function(results) {
                    if (!results.length) {
                        callback(entries.sort());
                    } else {
                        entries = entries.concat(toArray(results));
                        readEntries();
                    }
                }, errorHandler);
            };
            readEntries(); // Start reading dirs.
        }

        //Actual implementation of the FilePicker
        window.addEventListener("load", function() {
            showFS();
            document.querySelector('#myfile').onchange = function(e) {
                var files = this.files;
                addFilesIntoFS(files);
                console.log('duplication finished');
                showFS();
            };
            document.querySelector('#deleteFSContent').onclick = deleteFSContent;
        });

        //Delete Content of FS
        function deleteFSContent(){
            window.requestFileSystem(window.TEMPORARY, 64*1024*1024, function(fs) {
                getAllEntries(fs, function(entries){
                    entries.forEach(function(entry, i) {
                        entry.remove(function() {
                            console.log('File removed.');
                        }, errorHandler);
                    });
                });
            }, errorHandler);
            showFS();
        }

        <!--Drag'n'Drop-->

        //Function: Prevent Default Event
        function cancel(e) {
            if (e.preventDefault) { e.preventDefault(); }
            return false;
        }

        window.addEventListener('dragover', cancel);
        window.addEventListener('dragenter', cancel);
        window.addEventListener('drop', function (e) {
            e = e || window.event; // get window.event if e argument missing (in IE)
            if (e.preventDefault) { e.preventDefault(); } // stops the browser from redirecting off to the image.

            var dt    = e.dataTransfer;
            var files = dt.files;

            //TODO: Ugly way to check if the item is a folder
            if(files[0].type==""){
                console.log('Folder are not supported for drag \'n\' drop yet');
                return;
            }
            console.log(""+files);
            addFilesIntoFS(files);
            console.log('duplication finished');
            showFS();
        });

    </script>
    <style>
    </style>
</head>
<body>
<h1 align=center>A File Preview Demo</h1>
<input type="file" id="myfile" multiple />
<input type="button" id="deleteFSContent" value="delete Content in FS"/>
<div id="list"></div>
</body>
</html>
